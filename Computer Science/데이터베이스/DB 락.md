# Lock

DB는 데이터를 영속적으로 저장하는 시스템이다. 여러 요청들을 통해 데이터가 수정되고 조회된다. 이러한 요청이 동시에 발생할때 충돌없이 일관성을 유지하기 위해 Lock을 사용한다.

Lock은 트랜잭션 처리의 순차성을 보장하는 방법이다. 여기서 트랜잭션이란 DB를 다루는 나누어지지않는 최소 기능 단위(원자성)이다.

## Lock의 종류

Lock은 크게 공유 / 배타로 구분할 수 있습니다.

- 공유 Lock
  - 데이터를 읽을때 사용되는 lock입니다. 공유 lock은 동시에 접근이 가능합니다. 공유 lock이 설정된 데이터에는 베타 lock을 걸 수 없습니다.
- 베타 Lock
  - 데이터를 변경할 때 사용되는 lock입니다. Lock이 해제될때까지 다른 트랜젝션이 접근 할 수 없습니다.

## Lock 방식

- 비관적 Lock
  - 변경하고자 하는 레코드에 대해 잠금을 먼저 획득하고 변경 작업을 처리하는 방식
  - 현재 변경하고자 하는 레코드를 다른 트랜잭션에서도 변경할 수 있다는 비관적 가정을 하기 때문에, 먼저 잠금을 획득
  - 높은 동시성 처리에 유리하며, InnoDB가 기본으로 채택하고 있는 방식임 (MySQL)
- 낙관적 Lock
  - 각 트랜잭션이 같은 레코드를 변경할 가능성은 희박할 것이라고 낙관적으로 가정
  - 변경 작업을 먼저 수행하고, 마지막에 잠금 충돌이 있는지 확인
  - 문제가 있었다면 ROLLBACK 처리

## Lock 설정 범위

- 데이터 베이스 전체
  - 하나의 트랜젝션만 DB접근이 가능한 정의입니다. 일반적으로 사용하지 않지만, DB 자체 버전을 올리다던가 하는 경우에 사용합니다.
- 테이블
  - 테이블의 모든 행을 업데이트 하는 등 전체 테이블에 영향을 주는변경을 수행할 때 유용합니다. DDL(Create, Alter, Drop) 구문과 함께 사용됩니다.
- 행 (Row)
  - 일반적으로 사용되며, 행을 기준으로 lock 설정합니다.

## 블로킹 (Blocking)

베타락에 의해 트랜젝션이 진행되지 못하고 대기하는 생태를 말합니다. 블로킹이 해소되기 위해서는 앞의 트랙젝션이 커밋 혹은 롤백되어서 실행을 완료해야합니다. 이는 성능을 감소시키므로 최소화하는 전략을 사용해야합니다.

## 교착상태 (Deadlock)

두개의 트랜잭션이 각각 lock을 형성하고, 다음 진행에서 서로를 참조해서 데이터를 가져와야할때 발생합니다. 양쪽의 가정에 모순이 생겨 일반적인 방법으로는 해결되지 않습니다. 이럴때 에러를 발생시키거나 교착상태를 미리 예방하기 위해 접근 순서를 조절할 필요가 있습니다.
