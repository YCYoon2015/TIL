# 머신러닝 파이프라인

> Devops 중 하나인 MLops를 공부한다. 우선 머신러닝 파이프라인은 어떤 특성을 가지고, 어떤 생각으로 바라봐야 할지 넓은 그림을 그린다.

### ML 파이프라인은 왜 필요할까

머신러닝을 필요한 서버에 각각 만든다면, 만들기도, 관리하기도, 상황을 파악하기도 어렵다. 따라서 파이프라인 구축 (자동화)를 통해서 생산성과 장애 대응 능력을 높여야한다.

다른 알고리즘과 다르게 ML은 관리 (지속적 학습 또는 튜닝)을 하지않는다면 성능이 계속 하락한다. 따라서 지속적으로 관리해야하며 이를 위해서는 파이프라인이 필수적이다.

일반적인 알고리즘이 수행되는 앱은 장애가 발생했을때 문제를 명확히 찾을 수 있다. 수행되는 기능이 정상적으로 작동되지 않기 때문이다. 하지만, ML은 장애가 발생하더라도, 성능에 영향을 주기때문에 장애의 결과인지 학습의 결과인지 구분하기 어려운 경우가 많다.



### 기술부채를 줄이기 위해서

파이프라인이 왜 필요한지는 알았다. 파이프라인이 없다면 유지 보수에 지속적으로 많은 비용이 발생할테고, 이는 기술부채가 된다. 이러한 기술부채를 줄이는 전통적인 방법에는 일반적으로 아래와 같다.

- 리팩토링
- 종속성 제거
- 단위 테스트: 테스트 기반 개발 (TDD)
- API 강화: 규격화
- 미사용 코드 삭제
- 문서화



머신러닝 분야는 일반적인 소프트웨어 공학 분야보다 추상화(Abstraction)가 잘 이뤄지지 않는다.일반적인 소프트웨어는 객체 지향적인 방식이 표준화되어서, 특정 부분을 고치고 싶을때 필요한 객체들을 수정하면 된다. 하지만 ML모델의 경우 전체가 하나의 기능으로 연결되어 있어서 일부를 고친다면 다른 부분에 수정이 요구될 수 있다. 완벽하게 객체화가 불가능하다거나 종속성이 심하다고 이해할 수 있다. 또한, A -> B가 된다는 유닛테스트도 불가능하다.

따라서 ML분야는 기존의 기술부채를 제거하는 방법에 더하여 추가적인 개념이 필요하다.



### 머신러닝 문제 체크 사항 

> 파이프라인의 난이도를 결정한다.

- 데이터 변화 주기
  - 만약 자주 변하지 않는다면 매번 재배포를 선택할 수 있다.
- 모델 성능 저하 주기와 정도
  - 시간이 지날수록 데이터 예측 효율이 떨어진다. ML모델이 최신 데이터를 지속적으로 결과를 주는지, 아니면 학습된 데이터가 길게 유효한지 등을 고민한다.
- 라벨링 가능 범위
  - 새로 업데이트 되는 데이터셋은 라벨링이 가능한지 알아야한다. 지속적으로 학습이 되려면 라벨링이 필요하며, 어렵다면 슈도라벨이나 인력을 요구할 수 있다.
- 데이터셋의 퀄리티
  - 데이터셋이 신뢰할만한지는 학습단계에서부터 중요하다. 따라서 성능 모니터링과 모델 리뉴얼에 필요한 새로운 데이터셋의 퀄리티를 고민해야한다.
  - MLops를 잘하기 위해서는 데이터 엔지니어링을 필수적으로 해야한다. 

- 트리거
  - ML은 배포 후에도 지속적으로 학습이 요구되며, 이러한 학습 포인트를 트리거를 통해서 관리한다. 이는 시간이 될수도있고 데이터에 따른 명령이 될수도 있다. 또는 모델 성능이 저하되었을때 될수도있다. 또는 데이터 분포가 변동되는 시점은 수학적으로 계산하여 설정할 수 있다.



### MLops의 수준 (구글 기준)

#### Level 0

- 수동 스크립트 중심, 대화식 프로세스
- ML과 운영 분리
- CI/CD 없음
- 배포는 예측 서비스에 해당
- active 성능 모니터링 부족

#### Level 1

- 연속적인 학습 관리
- 빠른 실험
- 프로덕션 모델의 CT
- ML 코드 모듈화
- 지속적인 모델 제공
- 파이프라인 배포

#### Level 2

- 자동화된 CI/CD 
- CI/CD 결과로 ML 개발자가 파라미터 모니터링 가능



### ML 파이프라인 단계

![image-20211208221327034](211208_ML pipeline.assets/image-20211208221327034.png)

- Data ingestion/versioning
  - 데이터 수집단계이다. 모델 성능에 결정적인 영향을 주는 단계라고 볼 수 있다. 필요한 피처가 무엇인지 잘 정의하고 학습 데이터를 적극적으로 획득해야한다.
  - 머신러닝은 일반적으로 데이터가 많을수록 좋다. 따라서 데이터 유입을 자동화시켜야한다. 데이터 엔지니어링의 영역에 가깝다. 
  - 최종적으로 원하는 데이터셋을 그리고, 역으로 이것을 raw data에서 어떻게 획득할지를 그려나가는 과정이다.
  - 여기서 vesioning을 하는데, 이는 재현가능성을 높이기 위해서이다. 요새 많이 사용하는 툴은 `object storage`, `AWS S3`, `GSC`이다. 날짜단위 등 버전을 만들어서 수집하면된다.
- Data validation
  - 들어온 데이터의 타당성을 검증한다. 유효성 검사이다.
  - 이상징후가 감질될 경우 데이터과학자에게 경고한다.
  - 공식적인 Test dataset을 만들고 이를 이용해서 유효성 검사를 진행할 수 있다. 
  - `TSDB`가 좋은 툴이될수있다. 여기에서 이상치 감지 함수를 사용한다.
- Data preprocessing
  - 데이터 전처리 단계이다. 모델이 이해하는 형태로 데이터를 가공해야한다.
  - 이 단계에서 이미지를 텐서로 변환하거나, 텍스트 토큰을 벡터화 하는 등 과정이 수행된다.
  - 피처를 만들고 정규화하는 과정이 모델 성능에 영향을 크게 미친다. 따라서 여기 단계는 리서처가 많이 관여하는 단계이다.
  - 전처리는 batch단위로 한번에 많이 하는것이 좋다. 반복적으로 코드가 수행되지 않게 효율성을 고려햐여 설계해야한다.
- Model training / Model tuning
  - 모델 재학습이 이뤄지는데 이것을 자동화하지 않는다면 매번 연구자가 개발을 해야한다. 이는 반복업무이다.
  - 가장낮은 오차를 가진 모델을 만들어야 하지만, 여기서 훈련은 효율성을 고려해야한다. 한정된 자원에서 성능이 포화되는 과정을 잡아서 모델을 최적화한다.
  - `autoML`이 좋은 툴이 될 수 있다.
- Model analysis 
  - 모델을 분석하는 단계이다. 정확도나 손실을 이용하여 최적의 모형 모수 집합을 결정한다.
  - 공정하게 모델을 평가하기 위해서는 더 다양한 통계 방식이 들어갈 수 있다.
- Model validation
  - 모델 버전관리이다. 데이터셋, 하이퍼 파라미터, 성능 등을 기록한다. git과 비슷하게 스테이지 관리를 해준다. 이는 일반적인 SW와 다르게 ML만의 트리거 포인트에 맞게 배포한다.
  - `MLflow` 가 좋은 툴이 될 수 있다.
- Model deployment
  - 모델 배포이다. 모델이 적다면 직접 배포할 수 있지만, 모델이 매우 많다면 파이프라인을 통해서 배포할 수 밖에 없다. 배포를 자동화하는 이유이다.
  - `Tensorflow serving`, `torchserve`, `gRPC` 가 좋은 툴이 될 수 있다.
- Model feedback
  - 배포된 모델의 성능을 측정해야한다. 인풋과 예측 결과를 기록해야한다. 
  - `TSDB`로 가능하다.



### 개인정보 보호

개인정보는 매우 민감한 이슈이다. 따라서 파이프라인에서 필요한 데이터만 암호화하여 관리하고, 빠르게 처리하는 등 법률에 맞게 운영되어야 한다.





### Ref.

- https://cloud.google.com/architecture/mlops-continuous-delivery-and-automation-pipelines-in-machine-learning
- https://www.redhat.com/ko/topics/devops/what-is-ci-cd
- https://lsjsj92.tistory.com/579
- https://docs.microsoft.com/ko-kr/azure/machine-learning/concept-ml-pipelines
- http://datacrew.tech/ml-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B81-tfx%EB%A1%9C-%EB%B3%B4%EB%8A%94-ml-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8/



---

> 여기서 부터는 글의 맥락과는 맞지 않지만 공부하면서 찾아본 개념 정리입니다.

#### CI/CD

- 지속적인 통합(Continuous Integration) / 지속적인 서비스 제공(Continuous Delivery)
- 개발 단계를 자동화하여 앱을 짧은 주기로 배포하겠다는 의미이다.
- 앱 개발과 테스트 및 배포를 자동화시킨다.

