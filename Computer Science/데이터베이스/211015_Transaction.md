# Transaction (트랜잭션)

> DB는 다양한 사용자가 동시에 만지고 수정한다. 이러한 동시 다발적인 사용에서 오류를 발생해서 안되고 또한 빠르게 작업들을 처리해야 한다. 데이터 무결성을 확보하면서 이런 작업을 가능하게 하는것을 공부해본다.

## 트랜잭션?

- 데이터 베이스의 DML(데이터 조작어, 조회 삽입 수정 삭제)의 논리적인 작업
- DML 실행과 실행에 대한 커밋(or 롤백) 단계
- (Select 조회 ->) DML 실행 -> Commit/Rollback -> 결과 



## 트랜잭션의 특징 (ACID)

1. 원자성 (Atomicity): 트랜잭션의 결과는 이루어졌거나 아무일도 없었거나 둘중 하나이다.
2. 일관성 (Consistency): 트랜잭션이 성공하면 DB는 일관성이 보장되어야 한다.
3. 고립성 (Isolation): 트랜잭션은 서로 중간 결과를 주고받지 않는다.
4. 지속성 (Durability): 해당 트랜잭션이 성공하면 DB에 결과 반영은 영구적이다. (일시적이지 않다)

### 예시

만약 A가 B에게 돈을 이체한다고 가정하자. 돈의 기록은 은행 DB에 저장되어있다. 

1. A가 이체를 요청했는데 A 휴대폰이 갑자기 꺼져서 완전하게 이체가 진행되지 않았다면, 원자성에 따라 아무일도 발생하지 않았다. 
2. 만약 정상 이체가 되었다면, A는 돈이 빠져나가고 B는 그만큼 돈이 들어와서 일관성을 만족해야 한다. 둘다 돈이 나가거나 둘다 돈이 남아있을 수 없다.
3. A가 계좌에서 돈을 빼고있는데, 부모님 AA가 계좌에 요청해서 돈을 뺄 수 없다. A가 요청한 트랜잭션이 완료되고 나서 다음에 AA의 트랜잭션이 수행된다. 또한, A가 계좌에서 돈을 빼라는 트랜잭션은 다른 누군가의 명령들을 참고하여 수행되지도 않는다.
4. A의 이체 트랜잭션이 끝나면 기록은 DB에 저장되어 변경 전까지 남는다.



## 트랜잭션 과정

<img src="211015_Transaction.assets/image-20211015211110716.png" alt="image-20211015211110716" style="zoom:70%;" />

가장 흔하게 볼수있는 트랜잭션 이미지이다. 위 예시를 통해 DB가 반영되는 모습을 생각한다면 크게 어렵지 않다.

여기서 흥미로운 화살표는 완료(commit) -> 철회(Rollback)이다. 커밋이 발생하더라도 다시 철회가 가능하다.

- Commit: 트랜잭션의 모든 변경을 DB에 영구적으로 반영한다.
- Rollback: 트랜잭션의 진행되던 변경을 포기하고 원래 모습으로 되돌린다.

트랜잭션은 SQL을 사용하며 수동 또는 자동적으로 수행된다. 따라서 내가 쓰는 SQL이 어떤 트랜잭션 특징을 가지는지 알아야 한다. 일반적으로 DML 명령은 수동으로 커밋이 요구되며, DDL 명령은 자동적으로 커밋이 수행된다.



## 동시성 제어

앞서 예시인 금융 거래와 같이 DB를 동시적으로 빠르게 만지면서 오류가 있지 않아야 한다. 이를 가능하게 하는것이 동시성 제어이다. 

동시성 제어를 이해하기 위해 정상적으로 트랜잭션이 수행되지 않았을 경우 발생되는 문제를 살펴보자.

### 발생 문제

- 불일치 현상
  - 두명 이상의 사용자가 DB를 조작할때 발생한다. A B A B 이렇게 커밋하면 서로간의 데이터 조작된 커밋으로 인해 원하지 않는 결과가 발생 할 수 있다. 
- 갱신 손실
  - 트랜잭션이 갱신한 내용을 다른 트랜잭션이 덮어쓰면서 이전 트랜잭션을 무효화하는 현상
- 연쇄 복귀
  - 트랜잭션이 변경을 취소하고 롤백하려 할때, 다른 트랜잭션으로 인해 취소가 불가능하게 되는 현상

### 해결 방안

이를 막는 방법은 대표적으로 로킹(락킹), 타임스탬프, 적합성 검증이 있다. DBMS는 트랜잭션 직렬화를 통해 정상적으로 동시성 제어를 수행한다.

- 로킹(locking)
  - 트랜잭션이 데이터에 록킹(locking)을 설정하면 다른 트랜잭션은 해당 데이터를 조작 할 수 없다. 
- 타임스탬프(timestamp)
  - 트랜잭션이 발생하면 접수번호를 부여하여 순서대로 처리한다.
- 적합성(validation) 검증
  - 트랜잭션을 수행하고 종료할때 적합성을 검증하여 DB에 최종적으로 반영한다.



